<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
  </head>
  <body>
    <span id="messageDisplay"></span>
    <br />
    <button type="button" id="messageButton">Click to send a test message</button>
  </body>
  <script type="text/javascript">
    // Simple test button
    document.getElementById('messageButton').onclick = function() {
      ThunkableWebviewerExtension.postMessage('ready');
    };

    // Main message handler
    ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
      try {
        const geojson = JSON.parse(message);

        if (geojson.type !== "FeatureCollection" || !geojson.features) {
          callback("Error: Not a valid GeoJSON FeatureCollection");
          return;
        }

        // Convert all features
        const formattedPolygons = geojson.features.map(feature => {
          const geom = feature.geometry;
          if (!geom || geom.type !== "Polygon") return [];

          // Each polygon can have multiple rings, weâ€™ll use the outer one (index 0)
          const coords = geom.coordinates[0].map(coordPair => {
            const [lon, lat] = coordPair;
            return { latitude: lat, longitude: lon };
          });

          return coords;
        });

        // Send back everything as one big list of polygons
        callback(JSON.stringify(formattedPolygons));

      } catch (err) {
        callback("Error parsing GeoJSON: " + err.message);
      }
    });
  </script>
</html>
